---
title: 记jenkins自动化集成发布中自己遇到的坑
date: 2017-08-27 11:11:18
tags:
	- jenkins
---

这几天，由于我接手了我们部门的内部告警系统的相关开发工作。所以向公司申请了dev环境的服务器，并且自己部署测试。老大希望我部署的时候使用jenkins自动的去部署服务器（当然我看到他们部署的时候特别方便，我也想装个b，以后就用jenkins了）。这期间遇到了很多问题。通过了两天的实践都一一的解决了。（话说网上的资料都一样或者相似，真的好吗）

<!-- more -->

## 通过jenkins发布的思路


为什么要用jenkins内，因为在没用jenkins的时候，我们更多的部署和发布项目是通过自己上传到tomcat或者jetty等ee容器中。然后重启容器。这里面就有几个问题了


* maven打包的问题，如果出错了就要不断的改，这个还好解决
* 发布出错，这里包括了单机和集群部署，这里就比较麻烦。（当然也可以通过shell脚本的方式进行，scp和启动tomcat等容器）。
* 部署统计，这个就不好解决了，因为没有一个比较标准并且简便的发布和构建调试工具的话，统计应该是一个比较麻烦的问题
* 所以，使用jenkins是可以解决这些问题的，还可以生成发布统计和通过率之类的。当通过测试后才部署，可以提高效率，而且可以发布到很多的服务器上。这些都是比我们自己去做的效率要高很多

我的发布思路经历过几个阶段

1、在我的开发机上部署jenkins，远程部署服务器。这个需要在本机安装jenkins，并且需要远程服务器连接（ssh 或者用户名密码登录）

2、在部署服务器上，进行部署。同时部署项目和jenkins服务（这就有一个大坑了 ）

## 遇到的问题

## maven本地setttings未引用

在我的电脑中，是有maven的settings在公司中的profiles文件的。在项目中一般我们都是手动激活release和snapshot。但是如果是使用jenkins的话，如果没有在pom.xml或者settings.xml中激活的话，会导致一些内网的版本jar无法下载。导致构建失败。这时就需要我们在上传我们的源代码时。把如何获取本地仓库和打开release和snapshot开关。

## jdk版本导致发布失败

在本机我是1.8，然后我用本机构建好了发往远程服务器部署的时候。tomcat报错，版本好检查错误。原因是因为我服务器上部署的jdk是1.7版（公司要求开发环境是1.7）。所以我的解决方式就只有在公司的服务器上进行部署和编译了。这样才能完成整个项目的发布。

## java永久区溢出的问题

这个问题是发生在jenkins安装在线上服务器后，由于是使用的jdk1.7，没有设置永久区的数值，而是使用的默认值。导致永久区溢出（这是在tomcat日志中看到的）。在jdk1.8采用元数据代替了永久区，元数据区是没有最大值限制的所以我本机没有出现这样的问题。如何解决呢！
这就需要在tomcat启动的时候设置较大的默认永久区大小（一般设置为128或者256m就可以了）。
如何设置这个可以百度一些。一般是在catalina.bat\sh中设定JAVA_OPTS的参数就可以了

##  如何重启tomcat服务器

当我把项目成功放到了tomcat的指定位置后，如果我在jenkins中使用关闭tomcat的命令，将无法让jenkins继续执行后续命令。
如何重启tomcat有是一个问题，这个问题我想了很久，当然也google、和百度了都没发现好的解决方案（因为他们应该这样做了，但是没有明确点出来）。
当时我的思路是在不重启tomcat的前提下发布项目：

1、首先rm -rf删除发布的项目

2、关闭端口20882（dubbo启动时调用的，我们的项目一般都是dubbo提供的服务）

3、放入刚刚构建好的war包，让tomcat自动的去解析和发布（当然要配置好tomcat的xml允许自动解析）。

lsof -i:20882
netstat -nap | grep 20882
awk ‘print $6’

但是这个思路是失败的。因为当我关闭端口20882的进程时，其实是杀死了java进程导致-tomcat也是被杀死了。

后面我发现了一个新的思路（这个确实解决了我的问题）


1、构建好后放到指定的位置

2、我再启用shell脚本，在脚本中重启tomcat 并且将项目放入webapps中（这就跨过了jenkins，而不会导致由于tomcat关闭导致脚本不执行的情况）

这样我就解决了重启tomcat。当然也让jenkins重启了一遍。

# 总结

在遇到这些问题的时候，我都比较冷静的去分析。也查看了tomcat logs和项目的log（发现了20882被占用的问题）。反正就是感觉第一次没经验。在很多方面都遇到了坑。而且在遇到坑后，由于有其他事情影响了我。导致效率不是很高。导致这两天就解决了这样一个问题。
希望接下来自己可以想清楚自己的路，然后让自己每天都有规划，在做一件事情的时候自己静下心来。好好的去处理好，一件事情一件事情的做好。

